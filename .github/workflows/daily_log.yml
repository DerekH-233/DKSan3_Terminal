name: DKSan3 Daily Log Generator (APOD Sync)
on:
  schedule:
    - cron: '0 21 * * *' # 北京时间凌晨 5 点运行
  workflow_dispatch:

jobs:
  generate_log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch NASA APOD Metadata
        id: apod_data
        run: |
          # 抓取 NASA 每日一图的元数据
          DATA=$(curl -s "https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY")
          TITLE=$(echo $DATA | jq -r '.title')
          DESC=$(echo $DATA | jq -r '.explanation | .[0:600]') # 截取前600字防止超出长度
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT

      - name: Generate Log via DeepSeek
        run: |
          # 将 NASA 数据作为上下文传给 DeepSeek
          RESPONSE=$(curl https://api.deepseek.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_KEY }}" \
            -d '{
              "model": "deepseek-chat",
              "messages": [
                {
                  "role": "system", 
                  "content": "你是一个名为 DKSan3 的深空观察员，隶属于深空联合 (DSU)。语气冷酷、科学，带有 15% 的感性扰动。禁止使用 Markdown 格式符号，禁止出现星号（*）。仅输出纯文本，通过换行表达逻辑。"
                },
                {
                  "role": "user", 
                  "content": "今日观测目标是: ${{ steps.apod_data.outputs.title }}。参考科学背景: ${{ steps.apod_data.outputs.desc }}。请以观察员 DKSan3 的身份撰写一篇 300 字以内的任务日志。你需要基于上述科学事实进行汇报，并融入 15% 的个人情绪扰动。开头请注明观测坐标和系统损耗。记住：绝对不准出现星号格式符号。"
                }
              ]
            }')
          
          CONTENT=$(echo $RESPONSE | jq -r '.choices[0].message.content')
          mkdir -p logs
          FILENAME="logs/$(date +%Y-%m-%d).txt"
          echo "$CONTENT" > $FILENAME

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add logs/
          git commit -m "AI_LOG_SYNC_NASA: $(date +%Y-%m-%d)"
          git push
