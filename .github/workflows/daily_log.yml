name: DKSan3 Daily Log Generator (APOD Sync)
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate_log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch NASA APOD Metadata
        id: apod_data
        run: |
          DATA=$(curl -s "https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY")
          TITLE=$(echo $DATA | jq -r '.title')
          DESC=$(echo $DATA | jq -r '.explanation | .[0:600]')
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "DESC=$DESC" >> $GITHUB_ENV

      - name: Generate Log via DeepSeek
        env:
          DEEPSEEK_KEY: ${{ secrets.DEEPSEEK_KEY }}
        run: |
          JSON_PAYLOAD=$(jq -n --arg title "$TITLE" --arg desc "$DESC" --arg sys_msg "你是一个名为 DKSan3 的深空观察员，隶属于深空联合 (DSU)。仅输出纯文本，禁止星号。" '{model: "deepseek-chat", messages: [{role: "system", content: $sys_msg}, {role: "user", content: ("今日观测: " + $title + "。背景: " + $desc + "。撰写300字日志，含坐标和损耗，融入15%感性扰动。无星号。")}]}')
          RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions -H "Content-Type: application/json" -H "Authorization: Bearer $DEEPSEEK_KEY" -d "$JSON_PAYLOAD")
          CONTENT=$(echo $RESPONSE | jq -r '.choices[0].message.content')
          
          mkdir -p logs
          DATE=$(date +%Y-%m-%d)
          FILENAME="logs/$DATE.txt"
          echo "$CONTENT" > $FILENAME
          
          # --- 核心新增：维护索引清单 ---
          MANIFEST="logs/manifest.json"
          if [ ! -f "$MANIFEST" ]; then echo "[]" > $MANIFEST; fi
          # 将新日期加入 JSON 数组（如果已存在则不重复加）
          UPDATED_JSON=$(jq --arg date "$DATE" --arg title "$TITLE" '. += [{"date": $date, "title": $title}] | unique_by(.date) | sort_by(.date) | reverse' $MANIFEST)
          echo "$UPDATED_JSON" > $MANIFEST

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add logs/
          git commit -m "AI_LOG_UPDATE: $(date +%Y-%m-%d)" || echo "No changes"
          git push
